<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Administrador de CatÃ¡logo</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.1.0/dist/handsontable.min.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f6fa;
      margin: 0;
      padding: 0;
    }
    header {
      background: #2f3640;
      color: #fff;
      padding: 15px 20px;
      font-size: 20px;
    }
    main {
      padding: 20px;
    }
    #saveBtn {
      background: #44bd32;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin-bottom: 15px;
    }
    #saveBtn:hover {
      background: #4cd137;
    }
    #hot {
      width: 100%;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <header>Panel de AdministraciÃ³n</header>
  <main>
    <button id="saveBtn">ðŸ’¾ Guardar cambios</button>
    <div id="hot"></div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/handsontable@14.1.0/dist/handsontable.min.js"></script>
  <script>
    const container = document.querySelector('#hot');
    let hot;

    // Renderer personalizado para mostrar miniaturas de fotos
    function imageRenderer(instance, td, row, col, prop, value, cellProperties) {
      Handsontable.renderers.BaseRenderer.apply(this, arguments);
      td.innerHTML = '';

      if (value && typeof value === 'string' && value.trim() !== '') {
        const img = document.createElement('img');
        img.src = value;
        img.width = 80;
        img.style.borderRadius = '6px';
        img.style.display = 'block';
        img.style.margin = '0 auto 4px auto';

        const link = document.createElement('a');
        link.href = value;
        link.target = '_blank';
        link.textContent = 'Ver';
        link.style.fontSize = '12px';
        link.style.display = 'block';
        link.style.textAlign = 'center';

        td.appendChild(img);
        td.appendChild(link);
      } else {
        td.textContent = 'â€”';
        td.style.textAlign = 'center';
      }

      return td;
    }

    // Cargar los datos del servidor
    async function cargarDatos() {
      const res = await fetch('/api/productos');
      const data = await res.json();

      hot = new Handsontable(container, {
        data: data,
        colHeaders: ['Foto', 'TÃ­tulo', 'Precio', 'Dimensiones', 'EnvÃ­o', 'Link'],
        columns: [
          { data: 'Foto', renderer: imageRenderer },
          { data: 'TÃ­tulo' },
          { data: 'Precio' },
          { data: 'Dimensiones' },
          { data: 'EnvÃ­o' },
          { data: 'Link' }
        ],
        rowHeights: 100,
        width: '100%',
        stretchH: 'all',
        autoWrapRow: true,
        manualRowResize: true,
        manualColumnResize: true,
        licenseKey: 'non-commercial-and-evaluation',
      });
    }

    // Guardar los cambios en el Excel
    async function guardarCambios() {
      const nuevosDatos = hot.getData();
      const headers = ['Foto', 'TÃ­tulo', 'Precio', 'Dimensiones', 'EnvÃ­o', 'Link'];
      const productos = nuevosDatos.map((fila) => {
        const obj = {};
        headers.forEach((h, i) => (obj[h] = fila[i]));
        return obj;
      });

      const res = await fetch('/api/guardar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(productos),
      });

      if (res.ok) {
        alert('Cambios guardados correctamente.');
      } else {
        alert('Error al guardar los datos.');
      }
    }

    document.querySelector('#saveBtn').addEventListener('click', guardarCambios);

    cargarDatos();
  </script>
</body>
</html>
