<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Administración</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.min.css">
  <script src="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.min.js"></script>
</head>
<body>
  <h1>Administración del Catálogo</h1>

  <div id="login-container">
    <input type="password" id="password" placeholder="Contraseña">
    <button id="btn-login">Ingresar</button>
  </div>

  <div id="admin-panel" style="display:none;">
    <div id="tabla" class="tabla"></div>
    <button id="btn-guardar">Guardar cambios</button>
    <button id="btn-logout">Salir</button>
  </div>

  <script>
    const tablaDiv = document.getElementById('tabla');
    let hot;

    async function login() {
      const password = document.getElementById('password').value;
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ password })
      });
      if (res.ok) {
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('admin-panel').style.display = 'block';
        cargarProductos();
      } else {
        alert('Contraseña incorrecta');
      }
    }

    async function cargarProductos() {
      const res = await fetch('/api/products', { credentials: 'include' });
      const productos = await res.json();
      const data = productos.map(p => [
        p.Foto || '',
        p.Título || '',
        p.Precio || '',
        p.Dimensiones || '',
        p.Envío || '',
        p.Link || ''
      ]);

      hot = new Handsontable(tablaDiv, {
        data,
        colHeaders: ['Foto', 'Título', 'Precio', 'Dimensiones', 'Envío', 'Link'],
        columns: [
          { data: 0, renderer: (instance, td, row, col, prop, value) => {
              td.innerHTML = value ? `<img src="${value}" style="height:50px">` : '';
            }
          },
          { data: 1 },
          { data: 2 },
          { data: 3 },
          { data: 4 },
          { data: 5 }
        ],
        rowHeaders: true,
        minSpareRows: 1,
        licenseKey: 'non-commercial-and-evaluation'
      });
    }

    async function guardarCambios() {
      const headers = ['Foto','Título','Precio','Dimensiones','Envío','Link'];
      const nuevosDatos = hot.getData().filter(row => row.some(v => v));
      const productos = nuevosDatos.map(fila => {
        const obj = {};
        headers.forEach((h,i) => obj[h] = fila[i] || '');
        return obj;
      });

      const res = await fetch('/api/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ products: productos })
      });

      if (res.ok) alert('Cambios guardados correctamente');
      else alert('Error al guardar');
    }

    async function logout() {
      await fetch('/api/logout', { method: 'POST', credentials: 'include' });
      location.reload();
    }

    document.getElementById('btn-login').addEventListener('click', login);
    document.getElementById('btn-guardar').addEventListener('click', guardarCambios);
    document.getElementById('btn-logout').addEventListener('click', logout);
  </script>
</body>
</html>
